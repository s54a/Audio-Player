<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="https://www.svgrepo.com/show/268463/music-player-music.svg"
      type="image/x-icon"
    />
    <title>Audio Loop Player</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        text-align: center;
        background-color: #121212;
        color: #e0e0e0;
      }
      #urlInput {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        margin-bottom: 20px;
        height: 54px;
        box-sizing: border-box;
        background-color: #1e1e1e;
        border: 1px solid #333;
        color: #e0e0e0;
        border-radius: 10px;
      }
      #playButton {
        padding: 10px 20px;
        background-color: #007fff;
        color: white;
        border: none;
        cursor: pointer;
        margin: 10px 0;
        transition: background-color 0.3s ease;
        border-radius: 10px;
        display: none;
      }
      #playButton:hover {
        /* background-color: lighten(#007fff, 50%); */
        background-color: #198cff;
      }
      #audioPlayer {
        margin-top: 20px;
        width: 100%;
      }
      #errorMessage {
        color: #ff6b6b;
        margin-top: 10px;
        display: none;
      }
      h1 {
        color: #e0e0e0;
      }
      /* audio::-webkit-media-controls { */
      /* background-color: #1e1e1e; */
      /* border-radius: 10px; */
      /* } */

      audio::-webkit-media-controls-enclosure {
        background-color: #999;
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Audio Loop Player</h1>
    <input type="text" id="urlInput" placeholder="Enter audio file URL" />
    <button id="playButton">Play</button>
    <div id="errorMessage"></div>
    <audio id="audioPlayer" controls loop autoplay></audio>

    <script>
      const urlInput = document.getElementById("urlInput");
      const playButton = document.getElementById("playButton");
      const audioPlayer = document.getElementById("audioPlayer");
      const errorMessage = document.getElementById("errorMessage");
      const savedUrl = localStorage.getItem("audioUrl");
      const savedTime = localStorage.getItem("audioTime");

      // Fade configuration
      const FADE_DURATION = 1000; // Duration of fade in milliseconds
      const FADE_INTERVAL = 50; // How often to update volume during fade (milliseconds)
      let fadeTimeout = null;

      // Load saved URL and playback time from localStorage on page load
      window.addEventListener("DOMContentLoaded", () => {
        if (savedUrl) {
          urlInput.value = savedUrl;
          audioPlayer.src = savedUrl;
          audioPlayer.loop = true;

          audioPlayer.addEventListener("loadedmetadata", () => {
            if (savedTime) {
              audioPlayer.currentTime = parseFloat(savedTime);
            }
          });
        }
      });

      // Save the current playback time in localStorage as the song plays
      audioPlayer.addEventListener("timeupdate", () => {
        localStorage.setItem("audioTime", audioPlayer.currentTime);
      });

      function fadeOut(onComplete) {
        const steps = FADE_DURATION / FADE_INTERVAL;
        const volumeStep = audioPlayer.volume / steps;

        const fade = () => {
          if (audioPlayer.volume > volumeStep) {
            audioPlayer.volume -= volumeStep;
            fadeTimeout = setTimeout(fade, FADE_INTERVAL);
          } else {
            audioPlayer.volume = 0;
            if (onComplete) onComplete();
          }
        };

        fade();
      }

      function fadeIn() {
        const targetVolume = 1.0;
        const steps = FADE_DURATION / FADE_INTERVAL;
        const volumeStep = targetVolume / steps;

        const fade = () => {
          if (audioPlayer.volume < targetVolume - volumeStep) {
            audioPlayer.volume += volumeStep;
            fadeTimeout = setTimeout(fade, FADE_INTERVAL);
          } else {
            audioPlayer.volume = targetVolume;
          }
        };

        fade();
      }

      async function playAudio(url) {
        // Clear any existing fade
        if (fadeTimeout) {
          clearTimeout(fadeTimeout);
        }

        // If audio is currently playing, fade it out first
        if (!audioPlayer.paused) {
          await new Promise((resolve) => {
            fadeOut(() => {
              audioPlayer.pause();
              resolve();
            });
          });
        }

        // Reset volume to 0 for fade-in
        audioPlayer.volume = 0;

        // Clear the saved playback time in localStorage
        localStorage.removeItem("audioTime");

        // Set the audio source and ensure loop is set
        audioPlayer.src = url;
        audioPlayer.loop = true;

        // When the metadata is loaded, reset the playback time and play with fade-in
        audioPlayer.addEventListener("loadedmetadata", () => {
          audioPlayer.currentTime = 0;
          audioPlayer
            .play()
            .then(() => {
              fadeIn();
            })
            .catch((error) => {
              errorMessage.textContent = `Error playing audio: ${error.message}`;
            });
        });
      }

      // Play button click handler
      playButton.addEventListener("click", () => {
        const audioUrl = urlInput.value.trim();

        if (!audioUrl) {
          errorMessage.textContent = "Please enter a URL";
          return;
        }

        // Save the URL to localStorage
        localStorage.setItem("audioUrl", audioUrl);

        // Call the playAudio function
        playAudio(audioUrl);
      });

      // Input field event handlers
      urlInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          playButton.click();
          urlInput.blur();
        }

        if (event.ctrlKey && event.key === "v") {
          setTimeout(() => {
            playButton.click();
            urlInput.blur();
          }, 100);
        }
      });

      // Error handling for audio element
      audioPlayer.addEventListener("error", (e) => {
        errorMessage.textContent =
          "Unable to load or play the audio file. Check the URL and file access.";
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", (event) => {
        if (event.key === "/") {
          event.preventDefault();
          urlInput.focus();
          urlInput.value = "";
        } else if (event.key === "Escape") {
          urlInput.blur();
          urlInput.value = savedUrl;
        } else if (event.code === "Space") {
          event.preventDefault();
          if (audioPlayer.paused) {
            audioPlayer.volume = 0;
            audioPlayer.play().then(() => fadeIn());
          } else {
            fadeOut(() => audioPlayer.pause());
          }
        }
      });
    </script>
  </body>
</html>
