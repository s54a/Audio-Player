<!DOCTYPE html>
<html lang="en">
  <!-- Maybe Create an npm package which then give a command to run a server  -->
  <!-- Or a bash function which cds into the directory and runs the server -->
  <!-- Then on a custom port localhost it run the website which now has the clipboard access -->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="https://www.svgrepo.com/show/268463/music-player-music.svg"
      type="image/x-icon"
    />
    <title>Player</title>
    <style>
      :root {
        --background-color: #f0f0f0;
        --text-color: #121212;
        --input-background: #ffffff;
        --input-border: #ccc;
        --button-background: #007fff;
        --button-hover: #198cff;
        --audio-controls-bg: #ccc;
      }

      html::-webkit-scrollbar {
        width: 0;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --background-color: #121212;
          --text-color: #e0e0e0;
          --input-background: #1e1e1e;
          --input-border: #333;
          --button-background: #007fff;
          --button-hover: #198cff;
          --audio-controls-bg: #999;
        }
      }

      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        text-align: center;
        background: #020106;
        background: -webkit-linear-gradient(
          to right,
          #070712,
          #0d0d1a,
          #020106
        );
        background: linear-gradient(to right, #070712, #0d0d1a, #020106);
      }

      #urlInput {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        margin-bottom: 20px;
        height: 54px;
        box-sizing: border-box;
        background-color: var(--input-background);
        border: 1px solid var(--input-border);
        color: var(--text-color);
        border-radius: 10px;
        outline: 0;
        border: 0;
        font-size: 1rem;
      }

      #playButton {
        padding: 10px 20px;
        background-color: var(--button-background);
        color: white;
        border: none;
        cursor: pointer;
        margin: 10px 0;
        transition: background-color 0.3s ease;
        border-radius: 10px;
        display: none;
      }

      #playButton:hover {
        background-color: var(--button-hover);
      }

      #audioPlayer {
        margin-top: 20px;
        width: 100%;
      }

      #errorMessage {
        color: #ff6b6b;
        margin-top: 10px;
        display: none;
      }

      h1 {
        color: var(--text-color);
      }

      audio::-webkit-media-controls-enclosure {
        background-color: var(--audio-controls-bg);
        border-radius: 10px;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin-top: -10rem;
      }
    </style>
  </head>
  <body>
    <!-- <h1>Audio Loop Player</h1> -->
    <div class="container">
      <input type="text" id="urlInput" placeholder="Enter audio file URL" />
      <button id="playButton">Play</button>
      <div id="errorMessage"></div>
      <audio id="audioPlayer" controls loop autoplay></audio>
    </div>

    <script>
      const urlInput = document.getElementById("urlInput");
      const playButton = document.getElementById("playButton");
      const audioPlayer = document.getElementById("audioPlayer");
      const errorMessage = document.getElementById("errorMessage");
      const savedUrl = localStorage.getItem("audioUrl");
      const savedTime = localStorage.getItem("audioTime");

      // Fade configuration
      const FADE_DURATION = 1000; // Duration of fade in milliseconds
      const FADE_INTERVAL = 50; // How often to update volume during fade (milliseconds)
      let fadeTimeout = null;

      // Load saved URL and playback time from localStorage on page load
      window.addEventListener("DOMContentLoaded", () => {
        if (savedUrl) {
          urlInput.value = savedUrl;
          audioPlayer.src = savedUrl;
          audioPlayer.loop = true;

          audioPlayer.addEventListener("loadedmetadata", () => {
            if (savedTime) {
              audioPlayer.currentTime = parseFloat(savedTime);
            }
          });
        }
      });

      // Save the current playback time in localStorage as the song plays
      audioPlayer.addEventListener("timeupdate", () => {
        localStorage.setItem("audioTime", audioPlayer.currentTime);
      });

      function fadeOut(onComplete) {
        const steps = FADE_DURATION / FADE_INTERVAL;
        const volumeStep = audioPlayer.volume / steps;

        const fade = () => {
          if (audioPlayer.volume > volumeStep) {
            audioPlayer.volume -= volumeStep;
            fadeTimeout = setTimeout(fade, FADE_INTERVAL);
          } else {
            audioPlayer.volume = 0;
            if (onComplete) onComplete();
          }
        };

        fade();
      }

      function fadeIn() {
        const targetVolume = 1.0;
        const steps = FADE_DURATION / FADE_INTERVAL;
        const volumeStep = targetVolume / steps;

        const fade = () => {
          if (audioPlayer.volume < targetVolume - volumeStep) {
            audioPlayer.volume += volumeStep;
            fadeTimeout = setTimeout(fade, FADE_INTERVAL);
          } else {
            audioPlayer.volume = targetVolume;
          }
        };

        fade();
      }

      async function playAudio(url) {
        // Clear any existing fade
        if (fadeTimeout) {
          clearTimeout(fadeTimeout);
        }

        // If audio is currently playing, fade it out first
        if (!audioPlayer.paused) {
          await new Promise((resolve) => {
            fadeOut(() => {
              audioPlayer.pause();
              resolve();
            });
          });
        }

        // Reset volume to 0 for fade-in
        audioPlayer.volume = 0;

        // Clear the saved playback time in localStorage
        localStorage.removeItem("audioTime");

        // Set the audio source and ensure loop is set
        audioPlayer.src = url;
        audioPlayer.loop = true;

        // When the metadata is loaded, reset the playback time and play with fade-in
        audioPlayer.addEventListener("loadedmetadata", () => {
          audioPlayer.currentTime = 0;
          audioPlayer
            .play()
            .then(() => {
              fadeIn();
            })
            .catch((error) => {
              errorMessage.textContent = `Error playing audio: ${error.message}`;
            });
        });
      }

      // Play button click handler
      playButton.addEventListener("click", () => {
        const audioUrl = urlInput.value.trim();

        if (!audioUrl) {
          errorMessage.textContent = "Please enter a URL";
          return;
        }

        // Save the URL to localStorage
        localStorage.setItem("audioUrl", audioUrl);

        // Call the playAudio function
        playAudio(audioUrl);
      });

      // Input field event handlers
      urlInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          playButton.click();
          urlInput.blur();
        }

        if (event.ctrlKey && event.key === "v") {
          setTimeout(() => {
            playButton.click();
            urlInput.blur();
          }, 100);
        }
      });

      // Error handling for audio element
      audioPlayer.addEventListener("error", (e) => {
        errorMessage.textContent =
          "Unable to load or play the audio file. Check the URL and file access.";
      });

      // // Keyboard shortcuts
      document.addEventListener("keydown", (event) => {
        if (event.key === "/") {
          event.preventDefault();
          urlInput.focus();
          urlInput.value = "";
        } else if (event.key === "Escape") {
          urlInput.blur();
          urlInput.value = savedUrl;
        } else if (event.code === "Space") {
          event.preventDefault();
          if (audioPlayer.paused) {
            audioPlayer.volume = 0;
            audioPlayer.play().then(() => fadeIn());
          } else {
            fadeOut(() => audioPlayer.pause());
          }
        }
      });

      document.addEventListener("paste", function (e) {
        // This will work when user manually pastes
        const text = e.clipboardData.getData("text");
        e.preventDefault();
        urlInput.focus();
        urlInput.value = "";
        urlInput.value = text;
        setTimeout(() => {
          playButton.click();
          urlInput.blur();
        }, 10);
      });
    </script>
  </body>
</html>
